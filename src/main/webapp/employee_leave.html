<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="UTF-8">
<title>My Leaves | EMS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
<link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
<link href="assets/css/main.css" rel="stylesheet">

<style>

body{
    background:#f4f7fb;
}

.card-box{
    background:#fff;
    border-radius:12px;
    padding:20px;
    box-shadow:0 2px 10px rgba(0,0,0,0.08);
}

.stat{
    font-size:22px;
    font-weight:600;
}

.badge-pending{
    background:#ffc107;
}

.badge-approved{
    background:#28a745;
}

.badge-rejected{
    background:#dc3545;
}

</style>
</head>


<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
<div class="container">

<a class="navbar-brand fw-bold" href="Employee.html">EMS</a>

<ul class="navbar-nav ms-auto">

<li class="nav-item">
<a class="nav-link" href="Employee.html">Dashboard</a>
</li>

<li class="nav-item">
<a class="nav-link" href="attendance-employee.html">Attendance</a>
</li>

<li class="nav-item">
<a class="nav-link" href="employee-payroll.html">Payroll</a>
</li>

<li class="nav-item">
<a class="nav-link active" href="#">Leaves</a>
</li>

<li class="nav-item">
<a class="nav-link text-warning" href="index.html">Logout</a>
</li>

</ul>

</div>
</nav>


<div class="container mt-5">

<h3 class="mb-4">My Leave Management</h3>


<!-- Summary -->
<div class="row g-4 mb-4">

<div class="col-md-4">
<div class="card-box text-center">
<p>Total Requests</p>
<div id="totalLeave" class="stat text-primary">0</div>
</div>
</div>

<div class="col-md-4">
<div class="card-box text-center">
<p>Approved</p>
<div id="approvedLeave" class="stat text-success">0</div>
</div>
</div>

<div class="col-md-4">
<div class="card-box text-center">
<p>Pending</p>
<div id="pendingLeave" class="stat text-warning">0</div>
</div>
</div>

</div>



<!-- Apply Leave -->
<div class="card-box mb-4">

<h5>Apply for Leave</h5>

<div class="row g-3 mt-2">

<div class="col-md-3">
<label>Leave Type</label>
<select id="leaveType" class="form-control">
<option value="">Select</option>
<option>Sick</option>
<option>Casual</option>
<option>Paid</option>
</select>
</div>

<div class="col-md-3">
<label>Start Date</label>
<input type="date" id="startDate" class="form-control">
</div>

<div class="col-md-3">
<label>End Date</label>
<input type="date" id="endDate" class="form-control">
</div>

<div class="col-md-3">
<label>Reason</label>
<input type="text" id="reason" class="form-control" placeholder="Reason">
</div>

</div>

<button onclick="applyLeave()" class="btn btn-primary w-100 mt-3">
Submit Request
</button>

</div>



<!-- History -->
<div class="card-box">

<h5>Leave History</h5>

<table class="table table-bordered mt-3">

<thead class="table-dark">
<tr>
<th>Type</th>
<th>Start</th>
<th>End</th>
<th>Reason</th>
<th>Status</th>
<th>Action</th>
</tr>
</thead>

<tbody id="records"></tbody>

</table>

<p id="noData" class="text-center text-muted mt-3 d-none">
No leave records found
</p>

</div>

</div>



<!-- Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index:9999">

<div id="toastBox" class="toast text-bg-success border-0">
<div class="d-flex">
<div class="toast-body" id="toastMsg"></div>
<button class="btn-close btn-close-white me-2" data-bs-dismiss="toast"></button>
</div>
</div>

</div>



<script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>


<script>

const toast=new bootstrap.Toast(document.getElementById("toastBox"));


function showToast(msg,color="success"){

let box=document.getElementById("toastBox");

box.className="toast text-bg-"+color+" border-0";

document.getElementById("toastMsg").innerText=msg;

toast.show();

}



// Set Min Date
document.addEventListener("DOMContentLoaded",()=>{

let today=new Date().toISOString().split("T")[0];

startDate.min=today;
endDate.min=today;

loadLeaves();

});



// Apply Leave
function applyLeave(){

let type=leaveType.value;
let start=startDate.value;
let end=endDate.value;
let reasonTxt=reason.value;


if(!type||!start||!end||!reasonTxt){

showToast("All fields required","danger");
return;

}


if(new Date(start)>new Date(end)){

showToast("Invalid date range","danger");
return;

}


fetch("EmployeeLeaveServlet",{

method:"POST",
headers:{"Content-Type":"application/x-www-form-urlencoded"},
body:`action=applyLeave&leaveType=${type}&startDate=${start}&endDate=${end}&reason=${reasonTxt}`

})

.then(r=>r.json())
.then(d=>{

showToast(d.message,"success");

clearForm();

loadLeaves();

});

}



// Clear Form
function clearForm(){

leaveType.value="";
startDate.value="";
endDate.value="";
reason.value="";

}



// Load History
function loadLeaves(){

fetch("EmployeeLeaveServlet?action=viewLeave")

.then(r=>r.json())
.then(data=>{

let rows="";
let total=0,approved=0,pending=0;


if(data.records.length===0){

noData.classList.remove("d-none");
records.innerHTML="";

resetSummary();
return;

}

noData.classList.add("d-none");


data.records.forEach(r=>{

total++;

if(r.status==="Approved") approved++;
if(r.status==="Pending") pending++;


let badge="";

if(r.status==="Approved"){
badge=`<span class="badge badge-approved">Approved</span>`;
}

else if(r.status==="Rejected"){
badge=`<span class="badge badge-rejected">Rejected</span>`;
}

else{
badge=`<span class="badge badge-pending">Pending</span>`;
}



let btn="--";

if(r.status==="Pending"){

btn=`
<button class="btn btn-sm btn-danger" onclick="cancel(${r.id})">
Cancel
</button>
`;

}


rows+=`

<tr>
<td>${r.leave_type}</td>
<td>${r.start_date}</td>
<td>${r.end_date}</td>
<td>${r.reason}</td>
<td>${badge}</td>
<td>${btn}</td>
</tr>

`;

});


records.innerHTML=rows;

updateSummary(total,approved,pending);

});

}



// Summary
function updateSummary(t,a,p){

totalLeave.innerText=t;
approvedLeave.innerText=a;
pendingLeave.innerText=p;

}


function resetSummary(){

totalLeave.innerText=0;
approvedLeave.innerText=0;
pendingLeave.innerText=0;

}



// Cancel
function cancel(id){

if(!confirm("Cancel this leave request?")) return;


fetch("EmployeeLeaveServlet",{

method:"POST",
headers:{"Content-Type":"application/x-www-form-urlencoded"},
body:`action=cancelLeave&id=${id}`

})

.then(r=>r.json())
.then(d=>{

showToast(d.message,"warning");

loadLeaves();

});

}

</script>


</body>
</html>
